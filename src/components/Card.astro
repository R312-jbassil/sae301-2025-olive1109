---
import Poubelle from'../../public/SVG/poubelle.svg';
const { svg = '<svg xmlns="http://www.w3.org/2000/svg"></svg>', name = 'Sans nom', date = null, id = null } = Astro.props;

function formatDate(d) {
  if (!d) return '';
  try {
    const dt = new Date(d);
    return dt.toLocaleString('fr-FR', { dateStyle: 'medium', timeStyle: 'short' });
  } catch {
    return String(d);
  }
}
---
<article class="w-full max-w-sm bg-white/90 rounded-xl shadow-md overflow-hidden border border-base-200" data-id={id ?? ''}>
  <div class="h-44 bg-base-100 flex items-center justify-center p-3 overflow-hidden">
    <!-- affiche le SVG passé en prop -->
    <div class="w-full h-full flex items-center justify-center" innerHTML={svg}></div>
  </div>

  <div class="p-4">
    <h3 class="text-base font-Playfair-Display text-secondary mb-1 truncate" title={name}>{name}</h3>
    <p class="text-xs text-base/70 mb-3">{formatDate(date)}</p>

    <div class="flex gap-18 items-center">
      {id ? (
        <a href={`/${id}`} class="w-auto btn btn-sm btn-outline btn-primary flex-1" aria-label={`Voir ${name}`}>Voir</a>
      ) : (
        <button class="btn btn-sm btn-outline btn-primary flex-1">Voir</button>
      )}

      {id ? (
        <button type="button" class="btn btn-sm btn-error ml-2" onclick="window.deleteCard && window.deleteCard(this)" title="Supprimer">
          <Poubelle class="w-4 h-4" />
        </button>
      ) : null}
    </div>
  </div>
</article>

<script>

<script>
  // helper available on window to delete a record and remove the card from DOM
  window.deleteCard = async function (btn) {
    const article = btn.closest('article[data-id]');
    const id = article?.dataset?.id;
    if (!id) { alert('Impossible de déterminer l\'id.'); return; }
    if (!confirm('Supprimer cette création ?')) return;

    try {
      btn.disabled = true;
      const res = await fetch('/js/deleteSVG', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });
      const json = await res.json();
      if (json?.success) {
        article.remove();
      } else {
        alert('Erreur suppression : ' + (json?.error || 'unknown'));
        btn.disabled = false;
      }
    } catch (err) {
      console.error(err);
      alert('Erreur réseau lors de la suppression.');
      btn.disabled = false;
    }
  };
</script>